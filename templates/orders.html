{% extends "base.html" %}
{% block title %}Мои заказы{% endblock %}

{% block content %}
<div class="main-layout">
  <section class="content">
    <h2>Мои заказы</h2>

    {% if orders %}
      <table class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>Номер заказа</th>
            <th>Список книг</th>
            <th>Кол-во книг</th>
            <th>Статус заказа</th>
            <th>Итого, ₽</th>
            <th>Действия над заказом</th>
            <th>Дата заказа</th>
          </tr>
        </thead>
        <tbody>
        {# ВАЖНО: всё, где используется "order", находится внутри этого цикла #}
        {% for order in orders %}
          <tr>
            <td>{{ order.id }}</td>

            <td>
              <ul>
                {% for item in order.items %}
                  <li>{{ item.book.title }}</li>
                {% endfor %}
              </ul>
            </td>

            <td>{{ order.items|length }}</td>

            <td>{{ order.status }}</td>

            <td>
              {{ '%.2f' % ((order.total or 0) | float) }} ₽
            </td>

            <td>
              {# Кнопка редактирования, если заказ ещё можно менять #}
              {% if order.status not in ['completed', 'cancelled'] %}
                <a class="btn btn-sm btn-secondary"
                   href="{{ url_for('order_edit', order_id=order.id) }}">
                  Редактировать
                </a>
              {% endif %}

              <form method="post"
                    action="{{ url_for('order_cancel', order_id=order.id) }}"
                    style="display:inline;">
                <button type="submit" class="btn btn-sm btn-warning">Отменить</button>
              </form>

              <form method="post"
                    action="{{ url_for('order_delete', order_id=order.id) }}"
                    style="display:inline;">
                <button type="submit" class="btn btn-sm btn-danger">Удалить</button>
              </form>
            </td>

            <td>{{ order.creation_date.strftime('%d.%m.%Y') }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>У вас пока нет заказов.</p>
    {% endif %}
  </section>
</div>
{% endblock %}
